@*
* Copyright 2015 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@(title: String,
pageName:Option[String] = None,
sidebarLinks: Option[Html] = None,
sidebarClass: Option[String] = None,
mainConfig: views.helpers.MainConfig = views.helpers.MainConfig(),
appConfig: config.ApplicationConfig = config.ApplicationConfig,
supportLinkEnabled: Boolean = true,
langSwitch: Option[play.twirl.api.Html] = None,
scriptElem: Option[Html] = None)(mainContent: Html)(implicit lang: Lang,
request: Request[_],
context: config.TamcContext,
breadcrumb: uk.gov.hmrc.play.breadcrumb.model.Breadcrumb,
user: Option[details.TamcUser] = None,
gaDimensions: Option[Map[String, String]] = None,
templateRenderer: uk.gov.hmrc.renderer.TemplateRenderer
)

@import play.twirl.api.Html
@import play.twirl.api.HtmlFormat
@import uk.gov.hmrc.play.views.html.layouts
@import uk.gov.hmrc.play.views.html.helpers
@import uk.gov.hmrc.play.frontend.auth.AuthContext
@import actions.JourneyEnforcers
@import config._
@import play.api.Play
@import play.api.Play.current
@import config.ApplicationConfig.webchatId
@import play.api.Play.current
@import play.api.i18n.Messages.Implicits._
@import utils.Helper._
@import uk.gov.hmrc.play.views.helpers.AttorneyRegime.standAlone


@scriptElement = {

        @config.OptimizelyConfig.optimizelyProjectId.map { projectId =>
            <script src="https://cdn.optimizely.com/js/@{projectId}.js"></script>
        }

        <script type="text/javascript">
                        function initCobrowse() {
                            if (typeof(eGain) != 'undefined' && eGain.cobrowse) {
                                eGain.cobrowse.startCobrowse();
                            }
                            else {
                                console.warn('eGain is not initialized')
                            }
                        }
                </script>
}





@signoutContent(user: Option[details.TamcUser]) = @{
    user.map { loggedInUser =>
    templates.user_status(
    user = loggedInUser,
    logoutUrl = controllers.routes.AuthorisationController.logout().url)
    }
}



@getHelpForm = {
   @includes.report_problem(supportLinkEnabled)
}

@commonContentHeader = {
    @if(user.isDefined && !breadcrumb.isEmpty && utils.isPtaJourneyUseOnlyOnAuthorisedPage(request)) {
        @breadcrumbTag(breadcrumb, false)
    }
    @if(ApplicationConfig.isWelshEnabled) {
        @langSwitch
    }
    @{
        user.map { loggedInUser =>
        templates.user_status(
        user = loggedInUser,
        logoutUrl = controllers.routes.AuthorisationController.logout().url)
        }
    }

<!--
    @if(user.isDefined && utils.isPtaJourneyUseOnlyOnAuthorisedPage(request)) {
    <div class="header-proposition">
        <div class="content">
            <a href="#proposition-links" class="js-header-toggle menu">@Messages("tamc.menu")</a>
            <nav id="proposition-menu">
                <a href="/pta/pta-home-1" id="proposition-name">@Messages("tamc.yourtaxaccount")</a>
                <ul id="proposition-links" class="header__menu__proposition-links">
                    <li><a id="sign-out" href="/marriage-allowance-application/logout">@Messages("user-status.sign-out")</a></li>
                </ul>
            </nav>
        </div>
    </div>
    } else {
    @HtmlFormat.empty
    }
-->
}

@if(ApplicationConfig.enableRefresh) {
    <meta http-equiv="refresh" content="@config.ApplicationConfig.refreshInterval; url=@controllers.routes.AuthorisationController.sessionTimeout()">
}


@links = {
    @if(user.isDefined && utils.isPtaJourneyUseOnlyOnAuthorisedPage(request)) {
        Map("url" -> routes.AuthorisationController.logout().url , "text" -> Messages("user-status.sign-out"))
    } else {
        Map.empty
    }
}


@mustacheCheck(str: String) = @{
    if(str.trim=="") false else str
}

@sidebar = {
    @if(sidebarLinks.isDefined) {
        @layouts.sidebar(sidebarLinks.get, sidebarClass)
    }
}


@previouslyLoggedInAt = @{
    val msg = user.fold("") { tamcUser => dates.formatEasyReadingTimeStamp(tamcUser.authContext.user.previouslyLoggedInAt, "") }
    mustacheCheck(msg)
}

@showLastLogInStatus = {
    user.isDefined
}

@actingAttorneyBanner = @{
    user.fold(HtmlFormat.empty) {
        authContext =>
            authContext.authContext.attorney.fold(HtmlFormat.empty) {
            _ =>  layouts.attorney_banner(authContext.authContext.principal.name, authContext.authContext.attorney.get.returnLink.url, standAlone, Some(Messages("attorney.banner.link")))
        }
    }
}

@googleAnalytics = @{
    Map[String, Any](
        "trackingId" -> ApplicationConfig.analyticsToken,
        "cookieDomain" -> ApplicationConfig.analyticsHost
    ) ++ gaDimensions.getOrElse(Map.empty)
}

@{
templateRenderer.renderDefaultTemplate(layouts.article(mainContent, false, None), Map[String, Any](
"pageTitle" -> s"$title",
"linkElems" -> Map(
    "url" -> routes.Assets.at("stylesheets/tamc.css")
 ),
"hasNavLinks" -> true,
"navTitle" -> pageName,
"removeServiceInfo" -> false,
"navLinks" -> links,

"betaBanner" -> true,
"feedbackIdentifier" -> "TAMC",
"includeHMRCBranding" -> true,

"actingAttorneyBanner" -> actingAttorneyBanner,
"mainContentHeader" -> commonContentHeader,
"sidebar" -> sidebar,
"getHelpForm" -> getHelpForm,
"googleAnalytics" -> googleAnalytics,

"scriptElems" -> Seq(
    Map("url" -> routes.Assets.at("javascripts/tamc.js"))
 ),

"inlineScript" -> scriptElement,

"mainClass" -> mainConfig,
"mainDataAttributes" -> mainConfig.maybeMainDataAttributes

))
}


